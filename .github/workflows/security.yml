# ============================================================================
# IMMUNE Security CI/CD Workflow
# ============================================================================
# Runs security checks on every push and PR:
# - Static analysis (cppcheck, clang-tidy)
# - Banned functions check
# - Sanitizer builds
# - Fuzz testing (optional)

name: Security

on:
  push:
    branches: [main, develop]
    paths:
      - 'immune/**'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [main]
    paths:
      - 'immune/**'

env:
  CC: clang
  CXX: clang++

jobs:
  # ==========================================================================
  # Static Analysis
  # ==========================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck clang-tools
      
      - name: cppcheck
        run: |
          cppcheck \
            --enable=all \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            -I immune/common/include \
            -I immune/agent/include \
            -I immune/hive/include \
            --xml --xml-version=2 \
            immune/ 2> cppcheck-report.xml || true
          
          # Check for errors
          if grep -q 'severity="error"' cppcheck-report.xml; then
            echo "::error::cppcheck found errors"
            cat cppcheck-report.xml
            exit 1
          fi
      
      - name: clang-tidy
        run: |
          find immune -name '*.c' -o -name '*.h' | head -50 | xargs -I{} \
            clang-tidy {} \
              -checks='clang-analyzer-*,cert-*,bugprone-*,performance-*' \
              -- \
              -I immune/common/include \
              -I immune/agent/include \
              -I immune/hive/include \
              2>/dev/null || true
      
      - name: Upload cppcheck report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.xml

  # ==========================================================================
  # Banned Functions Check
  # ==========================================================================
  banned-functions:
    name: Banned Functions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check for banned functions
        run: |
          BANNED="gets|sprintf|vsprintf|strcpy|strcat|strncpy|strncat"
          BANNED="$BANNED|scanf|sscanf|fscanf|vscanf|vsscanf|vfscanf"
          BANNED="$BANNED|realpath|getwd|mktemp|tempnam|tmpnam"
          
          echo "Checking for banned functions..."
          
          if grep -rE "\b($BANNED)\s*\(" --include='*.c' --include='*.h' immune/; then
            echo ""
            echo "::error::Banned functions detected!"
            echo "Please use safe alternatives from safe_memory.h"
            exit 1
          else
            echo "✓ No banned functions found"
          fi

  # ==========================================================================
  # Sanitizer Build (ASan + UBSan)
  # ==========================================================================
  sanitizer-build:
    name: Sanitizer Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Build with sanitizers
        run: |
          cd immune
          
          # Compile common library with sanitizers
          $CC -c common/src/safe_memory.c \
            -I common/include \
            -fsanitize=address,undefined \
            -fno-sanitize-recover=all \
            -fno-omit-frame-pointer \
            -g -O1 \
            -o safe_memory.o
          
          echo "✓ Sanitizer build successful"
      
      - name: Run sanitizer tests
        run: |
          cd immune
          
          # Compile and run tests with sanitizers
          if [ -f tests/test_safe_memory.c ]; then
            $CC tests/test_safe_memory.c common/src/safe_memory.c \
              -I common/include \
              -fsanitize=address,undefined \
              -fno-sanitize-recover=all \
              -fno-omit-frame-pointer \
              -g -O1 \
              -o test_safe_memory
            
            ./test_safe_memory
            echo "✓ Sanitizer tests passed"
          fi

  # ==========================================================================
  # Compiler Warnings
  # ==========================================================================
  compiler-warnings:
    name: Compiler Warnings
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Build with strict warnings
        run: |
          cd immune
          
          CC=${{ matrix.compiler }}
          
          CFLAGS="-Wall -Wextra -Wpedantic -Werror"
          CFLAGS="$CFLAGS -Wformat=2 -Wformat-security"
          CFLAGS="$CFLAGS -Wconversion -Wsign-conversion"
          CFLAGS="$CFLAGS -Wcast-qual -Wshadow"
          CFLAGS="$CFLAGS -Wstrict-prototypes -Wmissing-prototypes"
          CFLAGS="$CFLAGS -fstack-protector-strong"
          CFLAGS="$CFLAGS -D_FORTIFY_SOURCE=2"
          
          # Compile common library
          $CC -c common/src/safe_memory.c \
            -I common/include \
            $CFLAGS \
            -O2 \
            -o safe_memory.o
          
          echo "✓ Compiled with $CC without warnings"

  # ==========================================================================
  # Format Check (optional)
  # ==========================================================================
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install clang-format
        run: sudo apt-get install -y clang-format
      
      - name: Check formatting
        run: |
          find immune -name '*.c' -o -name '*.h' | while read file; do
            if ! diff -q "$file" <(clang-format --style=file "$file") > /dev/null 2>&1; then
              echo "::warning file=$file::File needs formatting"
            fi
          done
          
          echo "Format check complete (warnings only)"

  # ==========================================================================
  # Security Summary
  # ==========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [static-analysis, banned-functions, sanitizer-build, compiler-warnings]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Security Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.static-analysis.result }}" == "success" ]; then
            echo "✅ Static Analysis: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Static Analysis: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.banned-functions.result }}" == "success" ]; then
            echo "✅ Banned Functions: None found" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Banned Functions: Detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.sanitizer-build.result }}" == "success" ]; then
            echo "✅ Sanitizer Build: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Sanitizer Build: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.compiler-warnings.result }}" == "success" ]; then
            echo "✅ Compiler Warnings: None" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Compiler Warnings: Found" >> $GITHUB_STEP_SUMMARY
          fi
