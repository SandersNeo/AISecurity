# Shield Auth Migration — Requirements

## Обзор

Перенос функционала аутентификации и авторизации из устаревшего Gateway (Go) в Shield (C) для обеспечения единой точки безопасности.

---

## Функциональные требования

### FR-1: JWT Authentication
- **FR-1.1**: Система ДОЛЖНА поддерживать верификацию JWT токенов с алгоритмами HS256 и RS256
- **FR-1.2**: Система ДОЛЖНА извлекать claims из токена (sub, exp, iat, iss, aud)
- **FR-1.3**: Система ДОЛЖНА отклонять истёкшие токены
- **FR-1.4**: Система ДОЛЖНА поддерживать настраиваемые issuer и audience

### FR-2: Rate Limiting
- **FR-2.1**: Система ДОЛЖНА ограничивать запросы по IP-адресу
- **FR-2.2**: Система ДОЛЖНА ограничивать запросы по user ID (из JWT)
- **FR-2.3**: Система ДОЛЖНА использовать алгоритм token bucket
- **FR-2.4**: Система ДОЛЖНА возвращать HTTP 429 при превышении лимита
- **FR-2.5**: Система ДОЛЖНА включать заголовки X-RateLimit-*

### FR-3: Secrets Management
- **FR-3.1**: Система ДОЛЖНА интегрироваться с HashiCorp Vault
- **FR-3.2**: Система ДОЛЖНА кэшировать секреты локально
- **FR-3.3**: Система ДОЛЖНА автоматически обновлять истекающие leases

### FR-4: HTTP Integration
- **FR-4.1**: Система ДОЛЖНА работать как middleware в Shield HTTP server
- **FR-4.2**: Система ДОЛЖНА поддерживать whitelist путей без аутентификации
- **FR-4.3**: Система ДОЛЖНА логировать все попытки аутентификации

---

## Нефункциональные требования

### NFR-1: Performance
- **NFR-1.1**: JWT верификация < 1ms
- **NFR-1.2**: Rate limiting check < 0.1ms
- **NFR-1.3**: Vault fetch < 100ms (с кэшем < 0.01ms)

### NFR-2: Security
- **NFR-2.1**: Секреты не должны логироваться
- **NFR-2.2**: Ключи должны храниться в secure memory
- **NFR-2.3**: Timing-safe comparison для токенов

### NFR-3: Reliability
- **NFR-3.1**: Graceful degradation при недоступности Vault
- **NFR-3.2**: Fallback на локальные ключи

### NFR-4: Compatibility
- **NFR-4.1**: Совместимость с существующими JWT из Gateway
- **NFR-4.2**: Zero breaking changes для клиентов

---

## User Stories

### US-1: API Client Authentication
**Как** API клиент  
**Я хочу** отправлять JWT токен в заголовке Authorization  
**Чтобы** получить доступ к защищённым endpoint'ам

**Критерии приёмки:**
- [ ] Bearer token в заголовке Authorization принимается
- [ ] Невалидный токен возвращает 401
- [ ] Валидный токен пропускает запрос

### US-2: Rate Limited Access
**Как** администратор  
**Я хочу** ограничить запросы по IP  
**Чтобы** защитить систему от DDoS

**Критерии приёмки:**
- [ ] Превышение лимита возвращает 429
- [ ] Заголовки показывают оставшийся лимит
- [ ] Retry-After указывает время ожидания

### US-3: Secure Secrets
**Как** DevOps инженер  
**Я хочу** хранить JWT secret в Vault  
**Чтобы** не держать секреты в config файлах

**Критерии приёмки:**
- [ ] Секреты подгружаются из Vault при старте
- [ ] Автоматическое обновление при rotation
- [ ] Fallback при недоступности Vault

---

## Зависимости

| Зависимость | Версия | Назначение |
|-------------|--------|------------|
| wolfSSL | 5.7+ | Crypto operations |
| cJSON | 1.7+ | JSON parsing |
| libcurl | 8.0+ | Vault HTTP client |

---

## Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Vault недоступен | Medium | High | Fallback на локальные ключи |
| JWT library bugs | Low | Critical | Fuzzing, unit tests |
| Performance regression | Medium | Medium | Benchmarks в CI |

---

**Created:** 2026-01-09
