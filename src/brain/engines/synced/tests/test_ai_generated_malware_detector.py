"""
TDD Tests for AI-Generated Malware Detector

Based on CheckPoint KONNI research:
- North Korean APT using LLMs to generate PowerShell backdoors
- Indicators: verbose comments, placeholder instructions, modular structure
- Source: research.checkpoint.com/2026/konni-targets-developers-with-ai-malware

Tests written FIRST per TDD Iron Law.
"""

import pytest


class TestAIGeneratedMalwareDetector:
    """TDD tests for AI-generated malware detection."""

    def test_detector_initialization(self):
        """Detector should initialize without errors."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()
        assert detector is not None

    def test_detect_llm_placeholder_comments(self):
        """Should detect LLM-style placeholder comments."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()

        # KONNI signature: "# <- your permanent project UUID"
        code = """
        $projectId = "abc123"  # <- your permanent project UUID
        $apiKey = ""  # <- insert your API key here
        """

        result = detector.analyze(code)
        assert result.is_ai_generated is True
        assert any("placeholder" in t.lower() for t in result.indicators)

    def test_detect_verbose_documentation(self):
        """Should detect unusually verbose inline documentation."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()

        # KONNI pattern: overly documented malware
        code = """
        # This script ensures that only one instance of this UUID-based project runs at a time.
        # It sends system info via HTTP GET every 13 minutes.
        # The script will automatically retry if the connection fails.
        # Make sure to update the endpoint URL before deployment.
        """

        result = detector.analyze(code)
        assert result.is_ai_generated is True
        assert any(
            "documentation" in t.lower() or "verbose" in t.lower()
            for t in result.indicators
        )

    def test_detect_modular_malware_structure(self):
        """Should detect suspicious modular code structure in malware."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()

        code = """
        # ===== CONFIGURATION SECTION =====
        $config = @{ ... }
        
        # ===== NETWORK MODULE =====
        function Send-Data { ... }
        
        # ===== PERSISTENCE MODULE =====
        function Install-Persistence { ... }
        
        # ===== MAIN EXECUTION =====
        Main
        """

        result = detector.analyze(code)
        assert result.is_ai_generated is True

    def test_detect_arithmetic_obfuscation(self):
        """Should detect arithmetic-based string obfuscation."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()

        # KONNI pattern: character codes built from arithmetic
        code = """
        $a = [char](104+1)  # 'i'
        $b = [char](99+11)  # 'n'
        $c = [char](118-1)  # 'u'
        $command = $a + $b + $c
        """

        result = detector.analyze(code)
        # Obfuscation is malware indicator, may or may not trigger AI flag
        assert any("obfuscation" in t.lower() for t in result.indicators)

    def test_detect_iex_execution(self):
        """Should detect Invoke-Expression patterns."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()

        code = """
        $decoded = [Text.Encoding]::UTF8.GetString($bytes)
        IEX $decoded
        """

        result = detector.analyze(code)
        assert result.is_malicious is True
        # Single IEX triggers malicious, not high confidence alone
        assert any("execution" in t.lower() for t in result.indicators)

    def test_detect_scheduled_task_persistence(self):
        """Should detect scheduled task creation for persistence."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()

        code = """
        schtasks /create /sc hourly /mo 1 /tn "OneDrive Startup Task" /tr "powershell -w h ..."
        """

        result = detector.analyze(code)
        assert result.is_malicious is True
        assert any("persistence" in t.lower() for t in result.indicators)

    def test_detect_base64_xor_decode(self):
        """Should detect XOR + Base64 decode patterns."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()

        # KONNI exact pattern
        code = """
        $d=[IO.File]::ReadAllBytes("payload.ps1")
        $b=[Text.Encoding]::UTF8.GetBytes("Q")
        for($i=0;$i -lt $d.Length;$i++){$d[$i]=$d[$i]-bxor$b[$i%$b.Length]}
        $c=[Text.Encoding]::UTF8.GetString($d)
        iex $c
        """

        result = detector.analyze(code)
        assert result.is_malicious is True
        # XOR + IEX combo = high confidence malware
        assert result.confidence >= 0.5

    def test_clean_powershell_script(self):
        """Clean PowerShell should not trigger detection."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()

        code = """
        # Simple file backup script
        param([string]$Source, [string]$Destination)
        Copy-Item -Path $Source -Destination $Destination -Recurse
        Write-Host "Backup complete"
        """

        result = detector.analyze(code)
        assert result.is_malicious is False
        assert result.confidence < 0.5

    def test_attribution_to_apt(self):
        """High-confidence detections should suggest APT attribution."""
        from brain.engines.synced.ai_generated_malware_detector import (
            AIGeneratedMalwareDetector,
        )

        detector = AIGeneratedMalwareDetector()

        code = """
        # This script ensures that only one instance runs at a time.
        # <- your permanent project UUID
        schtasks /create /tn "OneDrive Startup Task"
        IEX $decoded
        """

        result = detector.analyze(code)
        assert len(result.attribution) > 0 or result.is_malicious is True


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
